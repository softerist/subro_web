# .github/workflows/ci.yml
name: Continuous Integration

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

# Cancel any previous workflow runs for the same branch/PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  scaffold-check:
    name: Check Scaffold Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify core directories exist
        run: |
          ls -d backend/app backend/tests frontend/src infra/docker docs || exit 1
          echo "Scaffold structure seems OK."

  # Placeholder for future test jobs
  # test-backend:
  #   name: Test Backend
  #   needs: scaffold-check
  #   runs-on: ubuntu-latest
  #   steps:
  #     - # ... setup python, install deps, run tests ...
  #
  # test-frontend:
  #   name: Test Frontend
  #   needs: scaffold-check
  #   runs-on: ubuntu-latest
  #   steps:
  #     - # ... setup node, install deps, run tests ...

  build-docker-images:
    name: Build Docker Images (Test)
    needs: scaffold-check # Depends on basic checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Backend API Image (Development Stage)
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          target: development # Build dev stage to check build process
          push: false # Don't push image in CI build test
          tags: subsapp-test-build-api:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend Image (Development Stage)
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          target: development # Build dev stage to check build process
          push: false # Don't push image in CI build test
          tags: subsapp-test-build-frontend:ci
          cache-from: type=gha
          cache-to: type=gha,mode=max