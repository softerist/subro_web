# GitLab Runner Configuration - Optimized for Performance
# =========================================================
# Copy to /etc/gitlab-runner/config.toml and restart: sudo systemctl restart gitlab-runner
#
# Optimized for: High-performance desktop (i9-12900KF, 16GB RAM, 24 threads)
# Adjust concurrent/cpus/memory based on your system specs

concurrent = 6                    # Max parallel jobs (rule of thumb: CPU cores / 4)
check_interval = 0                # Use default check interval
connection_max_age = "15m0s"      # Keep connections alive
shutdown_timeout = 300            # CRITICAL: Wait 5 min for jobs on restart/stop

[session_server]
  session_timeout = 1800

[[runners]]
  name = "MSI"
  request_concurrency = 6         # Jobs this runner can request simultaneously
  url = "https://gitlab.com/"
  # NOTE: These values are generated when you register the runner
  # Run: gitlab-runner register
  # id = <YOUR_RUNNER_ID>
  # token = "<YOUR_RUNNER_TOKEN>"
  executor = "docker"

  # Large git operations (buildkit, monorepos)
  pre_clone_script = "git config --global http.postBuffer 524288000"

  [runners.cache]
    MaxUploadedArchiveSize = 0
    [runners.cache.s3]
    [runners.cache.gcs]
    [runners.cache.azure]

  [runners.docker]
    tls_verify = false
    image = "alpine:latest"
    privileged = true             # Required for Docker-in-Docker
    disable_entrypoint_overwrite = false
    oom_kill_disable = false
    disable_cache = false
    volumes = ["/cache", "/certs/client", "/certs/server"]

    # Performance settings
    shm_size = 268435456          # 256MB shared memory (for browsers/Playwright)
    cpus = "4"                    # CPUs per container (prevents one job hogging all)
    memory = "4g"                 # Memory per container
    pull_policy = ["if-not-present"]  # Skip pulling if image exists locally

    # Network optimization
    dns = ["8.8.8.8", "1.1.1.1"]  # Fast public DNS
    network_mtu = 0

    # Pin helper image version to avoid re-pulling on every job
    helper_image = "gitlab/gitlab-runner-helper:x86_64-v18.7.1"
